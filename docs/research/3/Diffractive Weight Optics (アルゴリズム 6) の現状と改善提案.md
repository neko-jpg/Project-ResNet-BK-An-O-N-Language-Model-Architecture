Diffractive Weight Optics (アルゴリズム 6) の現状と改善提案
現状の実装と問題点

アルゴリズム 6「Diffractive Weight Optics」は、言語モデルの重みを光学的位相マスクに見立て、角スペクトル法による光の伝搬を用いて最適な位相補正を求める意欲的な試みです。実装の特徴は以下の通りです。

バンド制限角スペクトル法 (BLAS)：robust_transfer_function() では周波数平面上の転送関数 
𝐻
(
𝑓
𝑥
,
𝑓
𝑦
)
H(f
x
	​

,f
y
	​

) を計算し、evanescent 波マスクと周波数領域でのバンド制限を適用しています
github.com
。これによりサンプリング条件を満たさない高周波成分を除去し、エイリアシングを抑制します。

ゼロパディングによる線形畳み込み：propagate_asm() は入出力を 2 倍にパディングし、FFT→逆FFT の間で循環畳み込みを線形畳み込みに変換しています
github.com
。これは角スペクトル法で発生するラップアラウンドを防ぐための標準手法です。

1 step の逆伝搬による重み更新：synthesize_weights() ではモデル出力とターゲット出力をソフトマックスとして光学場に変換し、1 次元（語彙次元）の転送関数を用いて正・目標伝搬を行います。その位相差から重み更新ベクトルを計算し、1 ステップでモデルの全パラメータに適用しています
github.com
。

ベンチマークでは Strehl比≥0.95 と 収束ステップ≤1.05 が目標ですが、現状では Strehl 比 ≈0 と報告されています。問題の本質は以下の点にあります。

光学シミュレーションと重み更新ロジックの不一致：実装では語彙次元を 1 次元光学場として扱い、出力分布の平均を用いて伝搬していますが、実際のモデルパラメータは2D行列や高次元テンソルであり、物理的な光学伝搬と対応していません。重み更新がノイズのようになり Strehl 比が上がらない原因です。

1 ステップのみの位相補正：光学的な逆問題は一般に非線形で、位相マスクを1回の伝搬で求めるのは困難です。古典的な Gerchberg–Saxton (G‑S) アルゴリズムでは入力と出力の間で複数回のフーリエ変換を行い位相を反復的に更新しますが、本実装では1回の差分のみであり、理想的な位相への収束が望めません。

損失関数とパラメータ化の問題：D²NN（diffractive deep neural network）の研究では、位相と振幅のパラメータ化にシグモイドを用いると勾配消失が起こるため、ReLUベースのパラメータ化やクロスエントロピー損失が推奨されています
pmc.ncbi.nlm.nih.gov
。現実装では損失にクロスエントロピーを用いているものの、ソフトマックス場の平均のみを位相補正に利用しており、学習信号が弱い可能性があります。

最新研究に基づく改善策
1. バンド制限角スペクトル法の厳密な実装

Christian Eder の学位論文では、FFT による畳み込みが循環畳み込みになるため、ゼロパディングによりサンプリングレプリカ間隔を広げてラップアラウンドを抑える必要があると解説しています
hs-aalen.de
。しかし、伝搬距離が大きい場合にはパディングだけでは aliasing が避けられないため、周波数空間で伝搬関数を 楕円形のウィンドウでトリミングする Band‑Limited ASM (BLAS) が有効であると述べています
hs-aalen.de
。現在の robust_transfer_function() は矩形ウィンドウに近い形でバンド制限を行っていますが、論文では楕円窓が推奨されており、伝搬距離・ピクセルサイズに応じたウィンドウ半径を数式で計算すべきです。式 (4‑72)〜(4‑84) では最大空間周波数の計算方法が示されており、これを実装に反映することが望ましいです。

2. Gerchberg–Saxton 変法による位相回復

古典的な G‑S アルゴリズムは入出力間で複数回の FFT/IFFT を繰り返し、入力の振幅と出力の振幅をそれぞれ元のものに置き換えながら位相を更新します。しかし、収束が遅く近似解しか得られない欠点があります。近年提案された Single‑Phase Retrieval (SPR)、Double‑Phase Retrieval (DPR)、Multiple‑Phase Retrieval (MPR) などの改良アルゴリズムは、2倍・複数枚の位相マスクを用いることでより正確な位相復元が可能であり、光暗号やビームシェーピングに利用されています
pmc.ncbi.nlm.nih.gov
。本アルゴリズムでも位相マスクと重み更新の関係を G‑S 変法に置き換え、数ステップの反復で Strehl 比が改善するか検証すべきです。

3. 2D フィールドとモデル重みの一致

2D DFT への拡張：現行実装では語彙次元を 1D フィールドとして扱っていますが、モデルの重み行列やアテンションヘッドは 2D 配列です。robust_transfer_function() と propagate_asm() を 2D フィールドに拡張し、入力フィールドを重み行列（例：[d_model, vocab]）や特徴マップにマッピングすることで物理アナロジーを保てます。これにより、光学伝搬で得られる位相差が重み更新に直接対応し、Strehl 比の向上が期待されます。

位相と振幅の分離：出力のソフトマックス平均は振幅に相当し、位相更新のみに基づく重み更新では振幅情報が失われます。論文
pmc.ncbi.nlm.nih.gov
ではシグモイドによる振幅・位相パラメータ化の代わりに ReLU ベースのパラメータ化とバッチ正規化を採用し、クロスエントロピー損失と組み合わせることで勾配消失を回避しています。モデルパラメータを振幅と位相の2成分に分離し、それぞれ専用の学習規則を適用するアーキテクチャを検討します。

4. トレーニング戦略の改善

クロスエントロピー損失への統一：synthesize_weights() では目標出力に対してソフトマックス場の平均と1-hotを比較して位相補正を生成していますが、最終的なロスは単に学習前後の損失差から相対的な「位相精度」を計算しているだけです
github.com
。損失関数自体をクロスエントロピーに統一し、出力分布とターゲット分布の距離を直接最小化することで学習信号を強くします。光学伝搬はその中間モジュールとして扱い、勾配を自動微分経由でバックプロパゲートします。

反復的な重み更新と学習率スケジュール：位相補正を1回で適用するのではなく、複数ステップの微小更新として学習率を減衰させながら適用します。これにより非線形最適化問題の安定性が向上し、Strehl 比の改善が期待されます。

5. 精度と計算コストの両立

複素数精度の適切な選択：現行コードでは転送関数計算に float64 を使い、最終的に complex64 にキャストしています
github.com
。位相ラッピングを防ぐには複素数64ビットが望ましいですが、計算コストを考慮して更新ステップ数が増える場合は部分的に complex128 を保持するなど精度と速度のバランスを取りましょう。

zero-padding の調整：論文
hs-aalen.de
ではゼロパディングによるラップアラウンド低減の効果はあるが完全には消せないと述べられています。必要に応じて 4 倍や自動計算したパディングサイズを用い、BLAS のウィンドウ半径と合わせてサンプリング条件を満たすよう調整します。

まとめ

Diffractive Weight Optics は、モデル重みを光学的に解釈する斬新なアプローチですが、現状は語彙次元を1D光場に写像して1回の位相差で更新しているため Strehl 比が向上しません。Christian Eder の論文が示すように、ゼロパディングとバンド制限は必須ですが、高精度な 楕円ウィンドウによるBLASの実装と十分なパディングが必要です
hs-aalen.de
hs-aalen.de
。さらに、位相回復の分野で進化している Gerchberg–Saxton 変法 (SPR/DPR/MPR) を取り入れ反復的に位相を推定することで Strehl 比を大幅に改善できる可能性があります
pmc.ncbi.nlm.nih.gov
。モデルの重みと光学フィールドを2Dで整合させ、ReLU ベースのパラメータ化とクロスエントロピー損失に基づく訓練を行うことも有効です
pmc.ncbi.nlm.nih.gov
。これらの改良を組み合わせることで、理論的な Strehl 比 0.95 に近づけると考えられます。