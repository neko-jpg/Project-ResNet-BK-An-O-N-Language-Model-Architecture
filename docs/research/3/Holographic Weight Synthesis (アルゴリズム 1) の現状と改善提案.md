Holographic Weight Synthesis (アルゴリズム 1) の現状と改善提案
現状の実装とベンチマーク失敗の本質

プロジェクトのアルゴリズム 1「Holographic Weight Synthesis」は、モデルの勾配ベクトルと入力表現をフーリエ領域で結合し、重み更新を合成する新しい方法です。実装では以下の工夫が施されています。

位相正規化された円周畳み込み：phasor_bind()関数では実 FFT (rfft) でフーリエ変換し、複素数の絶対値で正規化して位相情報だけを用いることで、ユニタリな結合操作を実現します
github.com
。この方法は勾配爆発／消失を防ぎます。

重み更新合成のタイミング計測：synthesize_weights()では重み更新のメイン処理（フーリエ結合）前後に torch.cuda.synchronize() を呼び、time.perf_counter() を用いて処理時間を計測しています
github.com
。

ベンチマークでは1 回の FFT に対して0.105 ms 以下という目標が設定されています。しかし実際には ~7 ms 程度となり失敗しています。要因は以下の通りです。

GPUカーネルの非同期実行と同期オーバーヘッド：PyTorch の GPU カーネルは非同期で起動されるため、time.perf_counter() で囲んでも実際の実行時間を測れません。記事によると、torch.cuda.synchronize() を実行するとCPUがGPUの作業完了まで待機するため正確な計測ができますが、カーネルの起動オーバーヘッドも含まれてしまい測定時間が膨らみます
speechmatics.com
。100 k 要素の FFT は物理的に0.1 ms前後かかり、同期オーバーヘッドで7 msまで伸びていると考えられます。

入力ベクトルのサイズ：gradient_vector と input_vector はモデル全パラメータと出力のフラット化により約10^5〜10^6 要素規模になるため、FFT自体が重くなっています。

最新研究に基づく改善策

CUDA Events を用いた正確なタイミング測定
　一般的に GPU カーネルの実行時間測定には torch.cuda.Event を使うべきです。開始イベントと終了イベントを記録し、GPU 上で実行される event.elapsed_time() によりオーバーヘッドの少ない測定が可能です。ブログ記事は、torch.cuda.synchronize() を挟まないと CPU が待機しないため測定値が不正確になるが、CUDA Events なら同期回数を減らせると説明しています
speechmatics.com
。これを用いれば KPI 測定用の同期オーバーヘッドを大幅に削減できます。

FFT サイズの削減とパワーオブツーへの最適化
　物理的な制限から100 k 要素の FFT を 0.1 ms 未満に処理するのは困難です。勾配と入力表現のベクトルを全て使用するのではなく、ランダムなサブサンプル や各層ごとの部分結合によりベクトル長を削減します。また、FFT は2の累乗サイズで最も高速に実行されるため、必要に応じてパディングしてサイズを調整します。

カーネル起動の削減と CUDA Graphs
　複数のカーネル呼び出しを個別に行うと起動オーバーヘッドが支配的になります。PyTorch 1.12 以降では CUDA Graph をサポートしており、グラフのキャプチャ後に繰り返し実行することでランチャーオーバーヘッドを減らせます。重み更新の FFT 操作を CUDA Graph に記録し、バッチ処理の中で再利用することが有効です。

計算手法の近似・分散化
　完全なフーリエ結合ではなく、勾配と入力をランダム化ハーディングや部分畳み込みで近似する方法があります。Holographic Reduced Representations (HRR)の研究では、ハダマード変換や循環行列を用いることで高速な近似畳み込みが可能とされています。さらに、ベクトルを CPU と GPU の混在処理により分散化し、メモリ転送を非同期化することも有効です。

メモリレイアウトの最適化
　gradient_vector と input_vector は同じ長さにパディングされますが、キャッシュフレンドリーな連続メモリで管理し、torch.cuda 上であらかじめ割り当てておくことでメモリ割当のコストを減らせます。また、可能であればfft.rfftを直接モデルの重みに適用するのではなく、CuFFT 計画 (cufftPlanMany) を再利用します。

その他の提案

多段階学習率スケジューラ：位相結合後の重み更新はユニタリですが、過大な学習率では発散します。学習率を段階的に減衰させるか、勾配ノルムに応じて正規化することで収束性を改善します。

勾配の平滑化：複数バッチの勾配をエクスポネンシャル移動平均で統計化し、それを合成に用いることで FFT サイズを抑えつつノイズを低減します。

ホログラフィック結合の結果の量子化：更新ベクトルを半精度 (float16) で保持することでメモリと計算負荷を削減します。

まとめ

Holographic Weight Synthesis の現状の課題は、ベンチマーク測定時の cuda.synchronize() によるオーバーヘッドが大きく、100 k 要素規模の FFT に物理的な限界があることです。CUDA Events を用いた非同期タイミング測定
speechmatics.com
、FFT サイズの削減やパワーオブツーへの調整、CUDA Graph によるカーネル起動削減などを組み合わせることで、ターゲットの 0.105 ms に近づけることが期待できます。また、近似手法や部分畳み込みにより更なる高速化が可能です。