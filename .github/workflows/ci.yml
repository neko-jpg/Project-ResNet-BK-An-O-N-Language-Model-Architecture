name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 00:00 UTC
    - cron: '0 0 * * *'

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy
      
      - name: Run black
        run: black --check src/ tests/ examples/
      
      - name: Run isort
        run: isort --check-only src/ tests/ examples/
      
      - name: Run flake8
        run: flake8 src/ tests/ examples/ --max-line-length=100 --ignore=E203,W503
      
      - name: Run mypy
        run: mypy src/ --ignore-missing-imports

  test:
    name: Test Python ${{ matrix.python-version }} PyTorch ${{ matrix.pytorch-version }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11']
        pytorch-version: ['2.0.0', '2.1.0', '2.2.0']
        exclude:
          # PyTorch 2.2 doesn't support Python 3.8
          - python-version: '3.8'
            pytorch-version: '2.2.0'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Cache pip packages
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install PyTorch ${{ matrix.pytorch-version }}
        run: |
          pip install torch==${{ matrix.pytorch-version }} --index-url https://download.pytorch.org/whl/cpu
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-xdist
      
      - name: Run tests
        run: |
          pytest tests/ -v --cov=src --cov-report=xml --cov-report=term -n auto
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella

  test-gpu:
    name: Test with GPU
    runs-on: ubuntu-latest
    container:
      image: pytorch/pytorch:2.1.0-cuda12.1-cudnn8-runtime
      options: --gpus all
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest pytest-cov
      
      - name: Check CUDA availability
        run: |
          python -c "import torch; print(f'CUDA available: {torch.cuda.is_available()}')"
          python -c "import torch; print(f'CUDA version: {torch.version.cuda}')"
          python -c "import torch; print(f'GPU count: {torch.cuda.device_count()}')"
      
      - name: Run GPU tests
        run: |
          pytest tests/ -v -m "gpu" --cov=src --cov-report=xml

  benchmark:
    name: Run Benchmarks
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Run benchmarks
        run: |
          python scripts/mamba_vs_bk_benchmark.py --quick
      
      - name: Upload benchmark results
        uses: actions/upload-artifact@v3
        with:
          name: benchmark-results
          path: results/*.json

  docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install sphinx sphinx-rtd-theme
      
      - name: Build docs
        run: |
          cd docs
          make html
      
      - name: Upload docs
        uses: actions/upload-artifact@v3
        with:
          name: documentation
          path: docs/_build/html/

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest
      
      - name: Run integration tests
        run: |
          pytest tests/test_integration.py -v
      
      - name: Test examples
        run: |
          python examples/birman_schwinger_integration_demo.py
          python examples/scattering_router_demo.py
          python examples/semiseparable_demo.py

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Run Bandit security scan
        uses: tj-actions/bandit@v5.1
        with:
          targets: src/
          options: "-r -ll"
      
      - name: Run Safety check
        run: |
          pip install safety
          safety check --json

  compatibility:
    name: Test Compatibility
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.10']
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest
      
      - name: Run tests
        run: |
          pytest tests/ -v -k "not gpu"

  notify:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [lint, test, test-gpu, integration]
    if: failure()
    
    steps:
      - name: Send notification
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'CI pipeline failed!'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        if: always()
