# Phase 8: 10B Japanese LLM - RTX 3080 8GB Optimized (v2)
# =========================================================
# 日本語特化モデル設定 - 最適化版

# === Model Architecture ===
d_model: 4096
n_layers: 48
n_seq: 512
num_heads: 32
htt_rank: 16
hyperbolic_window_size: 64

# === Japanese Tokenizer ===
vocab_size: 32000
tokenizer_name: "rinna/japanese-gpt-neox-3.6b"

# === Ultra Compression ===
low_rank_ffn: true
low_rank_attention: true
low_rank_rank: 16
use_bitnet: true

# === Memory Optimization ===
use_gradient_checkpointing: true
gradient_checkpointing_segments: 12
use_mixed_precision: true
mixed_precision_dtype: bfloat16

# === Training ===
batch_size: 1
gradient_accumulation_steps: 32
effective_batch_size: 32

# === Optimizer (BK-HyperSGD - ResNet-BK専用) ===
optimizer_type: bk_hyper_sgd
beta1: 0.9
beta2: 0.95
eps: 1.0e-8
weight_decay: 0.01

# === Learning Rate Scheduler ===
# FIXME (2025-12-09): Reduced LR from 5e-3 to 1e-4 for grad norm stabilization
# Target: grad_norm avg ≤ 5.0, max ≤ 10.0
learning_rate: 1.0e-4  # Reduced from 5e-3 (50x reduction)
min_lr: 1.0e-6
warmup_steps: 2000

# === Gradient Control ===
grad_clip_warmup: 0.1  # Stricter warmup clipping
grad_clip_train: 1.0   # 通常時の制限
grad_skip_threshold: 10.0  # Failsafe: 異常な勾配爆発をスキップ

# === EMA (Exponential Moving Average) ===
use_ema: true
ema_decay: 0.999

# === Regularization ===
label_smoothing: 0.1
dropout: 0.1
attention_dropout: 0.1

# === Phase 8 Components ===
use_bk_hyperbolic: true
use_ar_ssm_fusion: true
enable_numerical_guards: true

# Disable heavy optional components
enable_entailment_cones: false
enable_persistent_homology: false
enable_sheaf_attention: false

# === Phase 8 Optimizations (NEW) ===
# Fused Möbius operations
use_fused_mobius: true

# Green function caching
use_green_function_cache: true
green_function_cache_size: 512

# Low-Rank SSM parallel scan
use_parallel_ssm_scan: true

# Fused scattering gate
use_fused_scattering_gate: true

# Hyperbolic distance batching
use_batched_hyperbolic_distance: true

# Resonance adaptive curvature
use_resonance_adaptive_curvature: true
resonance_threshold: 0.5
curvature_adjustment_rate: 0.01

# Ternary Möbius matmul
use_ternary_mobius_matmul: true

# === Triton Kernels ===
use_triton_kernel: true
triton_kernel_version: fast
triton_use_safe_ops: true
use_fused_kernels: true

# === torch.compile ===
# Note: Disabled on Python 3.12+
use_torch_compile: false
compile_mode: max-autotune

# === Flash Attention 2 ===
use_flash_attention_2: true

# === DataLoader ===
num_workers: 8
pin_memory: true
prefetch_factor: 4
persistent_workers: true

# === Logging ===
log_interval: 10
save_interval: 500  # 1000 -> 500
eval_interval: 500
save_dir: checkpoints/phase8_10b_japanese

# === Numerical Stability ===
max_norm: 0.99
numerical_epsilon: 1.0e-8
scale_epsilon: 1.0e-3

# === Moonshot Optimizations (Phase 2 & 3) ===
# #3 Eigenvalue Precomputation (Green Function LUT)
use_green_function_lut: true
green_function_lut_size: 1024

# #6 Resonance-Locked Training (skip low SNR updates)
use_resonance_locked: true
resonance_gns_threshold: 5.0

# #7 Scattering-Aware Attention Pruning
use_scattering_pruning: true
scattering_threshold: 0.1

# #8 Hyperbolic MoE (when using MoE layers)
use_hyperbolic_moe: true
hmoe_num_experts: 8
hmoe_top_k: 2

# #9 Gradient Teleportation (non-local gradient propagation)
# Scheduler managed: OFF during warmup (0-10%), ON after
use_gradient_teleportation: true
teleport_strength: 0.1

# #10 Time-Reversed Training (bi-directional consistency)
use_time_reversed: true
time_reversed_weight: 0.5

# #11 Holographic Compression (KV Cache)
use_holographic_kv_cache: true
holographic_compression_ratio: 0.25

# #12 Superposition Training (quantum-inspired)
use_superposition_training: false  # Heavy, enable manually
superposition_particles: 5

# === Revolutionary Training (7 Algorithms) ===
# Scheduler managed: Warmup(0-10%): OFF | Early(10-30%): 1/5 | Mid(30-70%): 1/3 | Late(70-100%): 1/2
use_revolutionary_training: true
revolutionary_auto_schedule: true
revolutionary_algorithms: "holographic,closed_form,topological,retrocausal,zeta,sheaf,diffractive"
